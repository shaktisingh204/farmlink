
{
  "rules": {
    "users": {
      "$uid": {
        // Users can read their own profile, but other authenticated users can read basic info.
        ".read": "auth != null",
        // Users can write to their own profile
        ".write": "auth != null && auth.uid == $uid"
      }
    },
    "produce": {
      ".indexOn": ["farmerId"],
      // Allow reads if the user is authenticated. This is a general rule.
      // Specific queries will need to be allowed as well.
      // For retailer 'browse' page, they fetch all produce, so a general read is ok.
      // For farmer 'my listings' page, we query by farmerId.
      ".read": "auth != null",
      "$produceId": {
        // Data must be a valid produce object
        ".validate": "newData.hasChildren(['name', 'variety', 'quantity', 'price', 'description', 'farmerId', 'createdAt'])",
        // Write access control: only a farmer can write to their own produce
        ".write": "auth != null && root.child('users/' + auth.uid).child('role').val() == 'farmer' && (newData.child('farmerId').val() == auth.uid || !newData.exists())"
      }
    },
    "orders": {
      // Users can only see their own orders
      ".indexOn": ["farmerId", "retailerId"],
      "$orderId": {
        ".read": "auth != null && (data.child('retailerId').val() == auth.uid || data.child('farmerId').val() == auth.uid)",
        // Only the retailer can create an order, and only involved parties can modify it
        ".write": "auth != null && ((!data.exists() && newData.child('retailerId').val() == auth.uid) || (data.exists() && (data.child('retailerId').val() == auth.uid || data.child('farmerId').val() == auth.uid)))",
         ".validate": "newData.hasChildren(['produceId', 'farmerId', 'retailerId', 'quantity', 'totalPrice', 'status', 'orderDate'])"
      }
    },
    "favorites": {
      "$retailerId": {
        // Retailers can only manage their own favorites list
        ".read": "auth != null && auth.uid == $retailerId",
        ".write": "auth != null && auth.uid == $retailerId"
      }
    },
    "alerts": {
       ".indexOn": ["userId"],
       "$alertId": {
         // Users can only manage their own alerts
        ".read": "auth != null && data.child('userId').val() == auth.uid",
        ".write": "auth != null && (!data.exists() || data.child('userId').val() == auth.uid)"
      }
    },
    "contactMessages": {
      // Anyone can submit a message
      ".write": true,
      // Only admins can read the messages
      ".read": "auth != null && root.child('users/' + auth.uid).child('role').val() == 'admin'",
      "$messageId": {
        ".validate": "newData.hasChildren(['name', 'email', 'message', 'timestamp'])"
      }
    }
  }
}
